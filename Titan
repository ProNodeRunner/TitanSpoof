#!/bin/bash

# Конфигурация
CONFIG_FILE="/etc/titan_nodes.conf"
BASE_IP="192.168.1.100"
TIMEZONE="Europe/Moscow"
LOGO_URL="https://raw.githubusercontent.com/ProNodeRunner/Logo/main/Logo"
ORANGE='\033[0;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

# Автоматическое определение интерфейса
NETWORK_INTERFACE=$(ip route | grep default | awk '{print $5}' | head -n1)

cleanup() {
    echo -e "${ORANGE}\n[*] Начинаем очистку системы...${NC}"
    sleep 1

    # Контейнеры
    if docker ps -aq --filter "name=titan_node" &>/dev/null; then
        echo -e "${ORANGE}[*] Остановка контейнеров...${NC}"
        docker stop $(docker ps -aq --filter "name=titan_node") 2>/dev/null
        sleep 1
        echo -e "${ORANGE}[*] Удаление контейнеров...${NC}"
        docker rm $(docker ps -aq --filter "name=titan_node") 2>/dev/null
        sleep 1
    else
        echo -e "${GREEN}[✓] Активные контейнеры не найдены${NC}"
    fi

    # Тома данных
    if docker volume ls -q --filter "name=titan_data" &>/dev/null; then
        echo -e "${ORANGE}[*] Удаление томов...${NC}"
        docker volume rm $(docker volume ls -q --filter "name=titan_data") 2>/dev/null
        sleep 1
    else
        echo -e "${GREEN}[✓] Тома данных не найдены${NC}"
    fi

    # Сеть
    echo -e "${ORANGE}[*] Восстановление сети...${NC}"
    for ip in $(seq 1 50); do
        sudo ip addr del $(echo $BASE_IP | awk -F. -v i="$ip" '{OFS="."; $4+=i; print}')/24 dev $NETWORK_INTERFACE 2>/dev/null
    done
    sleep 1

    # Сервис
    if systemctl is-enabled titan-node.service &>/dev/null; then
        echo -e "${ORANGE}[*] Отключение сервиса...${NC}"
        sudo systemctl stop titan-node.service
        sudo systemctl disable titan-node.service
        sudo rm -f /etc/systemd/system/titan-node.service
        sudo systemctl daemon-reload
        sleep 1
    fi

    # Проверка
    local containers=$(docker ps -aq --filter "name=titan_node" | wc -l)
    local volumes=$(docker volume ls -q --filter "name=titan_data" | wc -l)
    
    if [ $containers -eq 0 ] && [ $volumes -eq 0 ]; then
        echo -e "${GREEN}\n[✓] ВСЕ КОМПОНЕНТЫ УДАЛЕНЫ!${NC}"
    else
        echo -e "${RED}\n[✗] Обнаружены остатки:"
        [ $containers -gt 0 ] && docker ps -a --filter "name=titan_node"
        [ $volumes -gt 0 ] && docker volume ls --filter "name=titan_data"
        echo -e "${NC}"
    fi
}

# Остальные функции остаются без изменений...

case $1 in
    --auto-start)
        if [ -f $CONFIG_FILE ]; then
            source $CONFIG_FILE
            setup_nodes
        fi
        ;;
    *)
        while true; do
            show_menu
            read -p "Выбор: " choice
            case $choice in
                1) install_dependencies ;;
                2) setup_nodes ;;
                3) check_nodes ;;
                4) cleanup ;;
                5) exit 0 ;;
                *) echo -e "${RED}Ошибка выбора!${NC}"; sleep 1 ;;
            esac
        done
        ;;
esac
